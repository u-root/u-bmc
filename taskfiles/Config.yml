version: '3'

tasks:
  # Meta task to generate files containing configuration values
  generate:
    deps:
      - ssh-keys
      - sim-crt
    dir: config/generate
    cmds:
      - echo "Generating config..."
      - |
        go run \
        -ldflags "\
        -X main.gitVersion={{.GIT_VERSION}} \
        -X main.gitHash={{.GIT_HASH}}" \
        -tags "config {{.CLI_ARGS}}" \
        .
      - echo "Config generated successfully!"
    vars:
      GIT_VERSION:
        sh: git describe --tags --long --always
      GIT_HASH:
        sh: git rev-parse HEAD

  # Make sure list of allowed ssh public keys exists
  ssh-keys:
    dir: config/generate
    cmds:
      - touch ssh-pubkeys
    status:
      - ssh-pubkeys

  # Create pebble key
  sim-key:
    dir: config
    cmds:
      - |
        openssl ecparam \
        -name prime256v1 \
        -genkey \
        -noout \
        -out sim-pebble.key
      - cp sim-pebble.key generate/sim-pebble.key
    status:
      - test -f sim-pebble.key
      - test -f generate/sim-pebble.key

  # Create pebble certificate
  sim-crt:
    deps:
      - sim-key
    dir: config
    cmds:
      - |
        openssl req \
        -new \
        -x509 \
        -key sim-pebble.key \
        -out sim-pebble.crt \
        -subj /CN=sim-pebble \
        -reqexts SAN \
        -extensions SAN \
        -config sim-pebble.cnf \
        -sha256 \
        -days 36500
      - cp sim-pebble.crt generate/sim-pebble.crt
    sources:
      - sim-pebble.cnf
    generates:
      - sim-pebble.crt
      - generate/sim-pebble.crt
