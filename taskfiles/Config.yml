version: '3'

tasks:
  # Meta task to generate files containing configuration values
  generate:
    deps:
      - ssh-keys
      - sim-crt
    dir: config
    cmds:
      - echo "Generating config..."
      - GITVERSION={{.GIT_VERSION}} GITHASH={{.GIT_HASH}} go generate
      - echo "Config generated successfully!"
    vars:
      GIT_VERSION:
        sh: git describe --tags --long --always
      GIT_HASH:
        sh: git rev-parse HEAD

  # Make sure list of allowed ssh public keys exists
  ssh-keys:
    dir: config
    cmds:
      - touch ssh-pubkeys
    status:
      - ssh-pubkeys

  # Create pebble key
  sim-key:
    dir: config
    cmds:
      - |
        openssl ecparam \
        -name secp256r1 \
        -genkey \
        -noout \
        -out sim-pebble.key
    status:
      - test -f sim-pebble.key

  # Create pebble certificate
  sim-crt:
    deps:
      - sim-key
    dir: config
    cmds:
      - |
        openssl req \
        -new \
        -x509 \
        -key sim-pebble.key \
        -out sim-pebble.crt \
        -subj /CN=sim-pebble \
        -reqexts SAN \
        -extensions SAN \
        -config ./sim-pebble.cnf \
        -sha256 \
        -days 36500
    sources:
      - sim-pebble.cnf
    generates:
      - sim-pebble.crt
